#!name=WeChat_AdBlock_AutoUpdate
#!desc=微信朋友圈和公众号广告屏蔽，支持自动更新脚本，内嵌响应体重写脚本
#!version=1.0
#!author=ChatGPT + Zf112整合

[Rule]
# 微信基础域名直连，防止误封
DOMAIN-SUFFIX,weixin.qq.com,DIRECT
DOMAIN-SUFFIX,mp.weixin.qq.com,DIRECT
DOMAIN-SUFFIX,res.wx.qq.com,DIRECT

# 广告及第三方广告域名阻断
DOMAIN-SUFFIX,ad.weixin.qq.com,REJECT
DOMAIN-SUFFIX,micromsgad.com,REJECT
DOMAIN-SUFFIX,wechatad.com,REJECT
DOMAIN-SUFFIX,adsame.cn,REJECT
DOMAIN-SUFFIX,admaster.com.cn,REJECT
DOMAIN-SUFFIX,yuanbao.qq.com,REJECT
DOMAIN-SUFFIX,deepsee.qq.com,REJECT
DOMAIN-SUFFIX,meituan.com,REJECT
DOMAIN-SUFFIX,dp.meituan.com,REJECT
DOMAIN-SUFFIX,baidu.com,REJECT
DOMAIN-SUFFIX,toutiao.com,REJECT
DOMAIN-SUFFIX,byteimg.com,REJECT
DOMAIN-SUFFIX,snssdk.com,REJECT
DOMAIN-SUFFIX,pstatp.com,REJECT
DOMAIN-SUFFIX,ixigua.com,REJECT

[Script]
# 响应体重写，远程拉取脚本屏蔽广告数据
http-response ^https?:\/\/(mp|weixin)\.weixin\.qq\.com\/mp\/profile_ext
script-url=https://raw.githubusercontent.com/Zf112/loon/main/wechat_adblock_response.js
timeout=10
tag=微信公众号广告屏蔽

http-response ^https?:\/\/(mp|weixin)\.weixin\.qq\.com\/mp\/getappmsgext
script-url=https://raw.githubusercontent.com/Zf112/loon/main/wechat_adblock_response.js
timeout=10
tag=微信公众号文章广告屏蔽

http-response ^https?:\/\/weixin\.qq\.com\/cgi-bin\/mmbiz-bin\/
script-url=https://raw.githubusercontent.com/Zf112/loon/main/wechat_adblock_response.js
timeout=10
tag=微信朋友圈广告屏蔽

[Script-Content]
#!name=wechat_adblock_response.js
(function() {
  if (typeof $response === "undefined" || !$response.body) {
    $done({});
    return;
  }
  try {
    let body = $response.body;
    let obj = JSON.parse(body);

    // 朋友圈广告过滤
    if (obj.general_msg_list && Array.isArray(obj.general_msg_list)) {
      obj.general_msg_list = obj.general_msg_list.filter(item => {
        if (item?.app_msg_ext_info?.is_ad === 1) return false;
        return true;
      });
    }

    // 公众号广告过滤
    if (obj.advertisement_info && obj.advertisement_info.ad_type) {
      obj.advertisement_info = null;
    }

    if (obj.ad_info && obj.ad_info.ads) {
      obj.ad_info.ads = [];
    }

    if (obj.promotion_info) {
      obj.promotion_info = null;
    }

    if (obj.recommend_info && obj.recommend_info.ads) {
      obj.recommend_info.ads = [];
    }

    $done({body: JSON.stringify(obj)});
  } catch (e) {
    console.log("微信广告屏蔽脚本异常:", e);
    $done({});
  }
})();
