#!name=微信防转圈保活
#!desc=微信请求触发和定时保活插件（带打断转圈）
#!version=1.2
#!author=ChatGPT

[Rule]
# ====== 核心微信直连（防转圈 + 降延迟）======
DOMAIN,mp.weixin.qq.com,DIRECT
DOMAIN-SUFFIX,weixin.qq.com,DIRECT
DOMAIN-SUFFIX,wx.qq.com,DIRECT
DOMAIN-SUFFIX,wxapp.qq.com,DIRECT
DOMAIN-SUFFIX,open.weixin.qq.com,DIRECT
DOMAIN-SUFFIX,res.wx.qq.com,DIRECT

# ====== 消息推送 / 实时通信（低延迟关键）======
DOMAIN-SUFFIX,long.weixin.qq.com,DIRECT
DOMAIN-SUFFIX,short.weixin.qq.com,DIRECT
DOMAIN-SUFFIX,voice.weixin.qq.com,DIRECT
DOMAIN-SUFFIX,wxavs.qq.com,DIRECT
DOMAIN-SUFFIX,webrtc.weixin.qq.com,DIRECT
DOMAIN-SUFFIX,liveplay.myqcloud.com,DIRECT
DOMAIN-SUFFIX,liveplay.video.qq.com,DIRECT
DOMAIN-SUFFIX,qcloud.com,DIRECT
DOMAIN-SUFFIX,myqcloud.com,DIRECT

# ====== 文件传输 ======
DOMAIN-SUFFIX,file.wx.qq.com,DIRECT
DOMAIN-SUFFIX,wework.qpic.cn,DIRECT

# ====== 短链 ======
DOMAIN-SUFFIX,mmbizurl.cn,DIRECT

# ====== 腾讯通用 CDN ======
DOMAIN-SUFFIX,ugdtimg.com,DIRECT
DOMAIN-SUFFIX,gtimg.cn,DIRECT

# 微信官方域名
DOMAIN-SUFFIX,weixin.qq.com,DIRECT
DOMAIN-SUFFIX,mp.weixin.qq.com,DIRECT
DOMAIN-SUFFIX,res.wx.qq.com,DIRECT
DOMAIN-SUFFIX,wechat.com,DIRECT
DOMAIN-SUFFIX,weixin110.qq.com,DIRECT
DOMAIN-SUFFIX,qq.com,DIRECT

# 微信相关 IP 段
IP-CIDR,14.17.0.0/16,DIRECT
IP-CIDR,183.60.0.0/16,DIRECT
IP-CIDR,111.13.0.0/16,DIRECT
IP-CIDR,123.125.0.0/16,DIRECT

[Script]
# 定时每5分钟执行一次
cron "*/5 * * * *" script-name=trigger-keepalive.js, timeout=10, tag=微信定时保活
# 微信请求匹配时即时触发
http-request
regex=^https?:\/\/(weixin\.qq\.com|mp\.weixin\.qq\.com)\/
script-name=trigger-keepalive.js
timeout=6
tag=微信即时保活

[Script-Content]
#!name=trigger-keepalive.js
const KEEPALIVE_URLS = [
  "https://mp.weixin.qq.com/",
  "https://weixin.qq.com/",
  "https://res.wx.qq.com/zh_CN/htmledition/js/wxLogin.js"
];
const TIMEOUT = 6000;

// ----------------------
// 打断转圈请求
// ----------------------
if ($request && $request.url && $request.url.includes("mp.weixin.qq.com")) {
    $done({
        status: 200,
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({})
    });
}

// ----------------------
// HTTP GET 无日志
// ----------------------
async function httpGet(url) {
  return new Promise(resolve => {
    if (typeof $task !== "undefined" && $task.fetch) {
      $task.fetch({ url, method: "GET", timeout: TIMEOUT })
        .then(resp => resolve(resp.statusCode >= 200 && resp.statusCode < 400))
        .catch(() => resolve(false));
    } else if (typeof $httpClient !== "undefined") {
      $httpClient.get({ url, timeout: TIMEOUT }, (err, resp) => {
        if (err) resolve(false);
        else resolve(resp.status >= 200 && resp.status < 400);
      });
    } else {
      fetch(url, { method: "GET", cache: "no-store", mode: "cors" })
        .then(resp => resolve(resp.status >= 200 && resp.status < 400))
        .catch(() => resolve(false));
    }
  });
}

// ----------------------
// 保活执行
// ----------------------
const wechatUrlRegex = /^https?:\/\/(weixin\.qq\.com|mp\.weixin\.qq\.com)\/.+/i;

(async () => {
  if (typeof $request !== "undefined" && $request && $request.url && wechatUrlRegex.test($request.url)) {
    // 即时保活
    for (const url of KEEPALIVE_URLS) await httpGet(url);
    $done({});
  } else {
    // 定时保活
    for (const url of KEEPALIVE_URLS) await httpGet(url);
    if (typeof $done === "function") $done({});
  }
})();
